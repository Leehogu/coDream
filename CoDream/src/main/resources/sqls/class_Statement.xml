<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="class">

<resultMap type="java.util.HashMap" id="HashMap">
	<result property="hash_seq" column="HASH_SEQ"></result>
	<result property="value" column="VALUE"></result>
</resultMap>

<resultMap type="ClassDto" id="ClassDto">
	<result property="cl_seq" column="CL_SEQ"/>
	<result property="cl_title" column="CL_TITLE"/>
	<result property="cl_content" column="CL_CONTENT"/>
	<result property="teacher" column="TEACHER"/>
	<result property="price" column="PRICE"/>
	<result property="startday" column="STARTDAY"/>
	<result property="endday" column="ENDDAY"/>
	<result property="term" column="TERM"/>
	<result property="address" column="ADDRESS"/>
	<result property="maxmember" column="MAXMEMBER"/>
	<collection property="hashList" resultMap="HashMap"/>
</resultMap>


<!-- 강의 개설 -->
<insert id="insertClass" parameterType="ClassDto">
INSERT INTO CLASS
	(CL_SEQ, CL_TITLE, CL_CONTENT, TEACHER, PRICE, STARTDAY, ENDDAY, TERM, ADDRESS, MAXMEMBER)
	VALUES((SELECT NVL(MAX(CL_SEQ),0) FROM CLASS)+1, #{cl_title}, #{cl_content},
	#{teacher}, #{price}, #{startday}, #{endday}, #{term}, #{address}, #{maxmember})
</insert>

<!-- 신규 해시 등록 -->
<insert id="insertHash" parameterType="java.lang.String">
INSERT INTO HASH (HASH_SEQ, VALUE)
	VALUES((SELECT NVL(MAX(HASH_SEQ), 0)+1 FROM HASH), #{value})
</insert>

<!-- 해시태그 존재여부 검색 -->
<select id="checkHash" parameterType="java.lang.String" resultMap="HashMap">
SELECT HASH_SEQ, VALUE
	FROM HASH
	WHERE VALUE = #{value}
</select>

<!-- 해시태그별 강의 조회 -->
<select id="hashedClassList" parameterType="java.lang.String" resultType="ClassDto">
SELECT CL_SEQ, CL_TITLE, TEACHER
	FROM LINKHASH l JOIN HASH h USING(HASH_SEQ)
	WHERE VALUE = #{value}
</select>

<!-- 강의 해시 조회 -->
<select id="linkHashList" parameterType="java.lang.Integer" resultType="java.lang.String">
SELECT VALUE
	FROM LINKHASH JOIN HASH USING(HASH_SEQ)
	WHERE CL_SEQ = #{cl_seq}
</select>

<!-- 강의 해시 등록 -->
<insert id="updateLinkHash" parameterType="java.util.Map">
INSERT INTO LINKHASH (CL_SEQ, HASH_SEQ)
	VALUES(#{cl_seq},#{hash_seq})
</insert>

<!-- 강의 전체 조회 -->
<select id="classList" resultMap="ClassDto">
SELECT CL_SEQ, CL_CONTENT, CL_TITLE, TEACHER, PRICE, STARTDAY, ENDDAY, ADDRESS, VALUE  
	FROM CLASS LEFT OUTER JOIN LINKHASH USING(CL_SEQ) LEFT OUTER JOIN HASH USING(HASH_SEQ)
	ORDER BY CL_SEQ DESC
</select>

<!-- 강의 상세 조회 -->
<select id="classDetail" parameterType="java.lang.Integer" resultType="ClassDto">
SELECT CL_SEQ, CL_TITLE, CL_CONTENT, TEACHER, PRICE, STARTDAY, ENDDAY, TERM, ADDRESS, MAXMEMBER
	FROM CLASS
	WHERE CL_SEQ=#{cl_seq}
</select>

<!-- 수강 신청 -->
<insert id="insertStudent" parameterType="StudentDto">
INSERT INTO STUDENT (STUDENT, CL_SEQ, REGDATE, VISIT, STATUS)
VALUES(#{student}, #{cl_seq}, SYSDATE, #{visit}, #{status})
</insert>

<!-- 알림 서비스 대상 조회 -->
<select id="emailList" resultType="RegisterDto">
SELECT ID, EMAIL
        FROM REGISTER
        WHERE ADRECIEVE = 'Y'
</select>

</mapper>
